<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BetKing - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary) !important;
        }
        
        .points-badge {
            background: linear-gradient(45deg, var(--success), #2ecc71);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .bet-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        
        .bet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        .action-btn {
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .live-feed {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--primary);
            font-weight: 500;
            padding: 12px 20px;
        }
        
        .nav-tabs .nav-link.active {
            background: white;
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
        }
        
        .game-code {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-crown me-2"></i>BetKing
            </a>
            
            <div class="d-flex align-items-center">
                <div class="points-badge me-3">
                    <i class="fas fa-coins me-1"></i>
                    <span th:text="${user?.availablePoints}">1000</span> Points
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i>
                        <span th:text="${user?.username}">User</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                            <i class="fas fa-user-circle me-2"></i>Profile
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="d-inline">
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bet-card text-white" style="background: linear-gradient(45deg, #3498db, #2980b9);">
                    <div class="card-body text-center">
                        <i class="fas fa-bolt fa-2x mb-2"></i>
                        <h5>Active Bets</h5>
                        <h2 th:text="${userActiveBets?.size() ?: '0'}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bet-card text-white" style="background: linear-gradient(45deg, #27ae60, #229954);">
                    <div class="card-body text-center">
                        <i class="fas fa-trophy fa-2x mb-2"></i>
                        <h5>Wins</h5>
                        <h2 th:text="${user?.wins ?: '0'}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bet-card text-white" style="background: linear-gradient(45deg, #e67e22, #d35400);">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h5>In Progress</h5>
                        <h2 th:text="${inProgressBets?.size() ?: '0'}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bet-card text-white" style="background: linear-gradient(45deg, #9b59b6, #8e44ad);">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h5>Total Earned</h5>
                        <h2 th:text="${(user?.availablePoints ?: 1000) - 1000}">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="play-tab" data-bs-toggle="tab" data-bs-target="#play" type="button">
                    <i class="fas fa-gamepad me-2"></i>Play Game
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">
                    <i class="fas fa-history me-2"></i>History
                </button>
            </li>
        </ul>

        <div class="tab-content p-4" id="mainTabsContent">
            <!-- Play Game Tab -->
            <div class="tab-pane fade show active" id="play" role="tabpanel">
                <div class="row">
                    <!-- Create Bet Section -->
                    <div class="col-md-4">
                        <div class="card bet-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Bet</h5>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/create-bet}" method="post">
                                    <div class="mb-3">
                                        <label class="form-label">Game Type</label>
                                        <select name="gameType" class="form-select" required>
                                            <option value="classic">Classic</option>
                                            <option value="popular">Popular</option>
                                            <option value="challenge">Challenge</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Points to Bet</label>
                                        <input type="number" name="points" class="form-control" 
                                               min="10" max="1000" value="100" required>
                                        <div class="form-text">Min: 10, Max: 1000 points</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Title</label>
                                        <input type="text" name="title" class="form-control" 
                                               placeholder="Enter bet title" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100 action-btn">
                                        <i class="fas fa-rocket me-2"></i>Create Bet
                                    </button>
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                </form>
                            </div>
                        </div>

                        <!-- Active Bets -->
                        <div class="card bet-card mt-4">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Your Active Bets</h5>
                            </div>
                            <div class="card-body">
                                <div th:if="${userActiveBets?.empty}" class="text-center text-muted py-3">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p>No active bets</p>
                                </div>
                                <div th:each="bet : ${userActiveBets}" class="mb-3 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="status-badge" 
                                              th:classappend="${(bet.status.name() == 'COMPLETED') ? 'badge bg-success' : (bet.status.name() == 'CANCELLED') ? 'badge bg-secondary' : (bet.status.name() == 'DISPUTED') ? 'badge bg-warning' : 'badge bg-info'}"
                                              th:text="${bet.status.name()}">
                                        </span>
                                        <strong class="text-primary" th:text="'‚Ç±' + ${bet.points}"></strong>
                                    </div>
                                    <h6 th:text="${bet.title} ?: ${bet.gameType + ' Match'}"></h6>
                                    <div class="d-flex gap-2 mt-2">
                                        <th:block th:if="${bet.status.name() == 'PENDING'}">
                                            <form th:action="@{/bets/{id}/cancel(id=${bet.id})}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-outline-danger btn-sm action-btn"
                                                        onclick="return confirm('Cancel this bet?')">
                                                    Cancel
                                                </button>
                                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            </form>
                                        </th:block>
                                        <th:block th:if="${bet.status.name() == 'ACCEPTED' && bet.creator.username == user.username}">
                                            <button class="btn btn-warning btn-sm action-btn" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#shareCodeModal"
                                                    th:data-bet-id="${bet.id}">
                                                Share Code
                                            </button>
                                        </th:block>
                                        <th:block th:if="${bet.status.name() == 'CODE_SHARED'}">
                                            <button class="btn btn-primary btn-sm action-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#submitResultModal"
                                                    th:data-bet-id="${bet.id}">
                                                Submit Result
                                            </button>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Betting Feed -->
                    <div class="col-md-8">
                        <div class="card bet-card">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Live Betting Feed</h5>
                                <span class="badge bg-light text-dark" id="liveBetsCount">0 bets</span>
                            </div>
                            <div class="card-body p-0">
                                <div id="liveBetsContainer" class="live-feed">
                                    <div th:each="bet : ${availableBets}" class="p-3 border-bottom">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="badge bg-primary me-2">NEW</span>
                                                    <strong class="text-success" th:text="'‚Ç±' + ${bet.points}"></strong>
                                                </div>
                                                <h6 th:text="${bet.title} ?: ${bet.gameType + ' Challenge'}"></h6>
                                                <p class="mb-1 text-muted small">
                                                    <i class="fas fa-user me-1"></i>
                                                    <span th:text="${bet.creator.username}"></span>
                                                </p>
                                                <p class="mb-0 text-muted small">
                                                    <i class="fas fa-clock me-1"></i>
                                                    <span th:text="${#temporals.format(bet.createdAt, 'MMM dd, HH:mm')}"></span>
                                                </p>
                                            </div>
                                            <div class="text-end">
                                                <form th:action="@{/bets/{id}/accept(id=${bet.id})}" method="post">
                                                    <button type="submit" class="btn btn-success btn-sm action-btn"
                                                            th:onclick="|return confirm('Accept this ' + ${bet.points} + ' point bet?')|">
                                                        <i class="fas fa-check me-1"></i>Accept
                                                    </button>
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${availableBets?.empty}" class="text-center text-muted py-5">
                                        <i class="fas fa-search fa-2x mb-2"></i>
                                        <p>No active bets available</p>
                                        <p class="small">Create the first bet to get started!</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- In Progress Matches -->
                        <div class="card bet-card mt-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-play-circle me-2"></i>Matches in Progress</h5>
                            </div>
                            <div class="card-body">
                                <div th:if="${inProgressBets?.empty}" class="text-center text-muted py-3">
                                    <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                                    <p>No matches in progress</p>
                                </div>
                                <div th:each="bet : ${inProgressBets}" class="mb-3 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="status-badge bg-info" th:text="${bet.status.name()}"></span>
                                        <strong class="text-primary" th:text="'‚Ç±' + ${bet.points}"></strong>
                                    </div>
                                    <h6 th:text="${bet.title} ?: ${bet.gameType + ' Match'}"></h6>
                                    <p class="mb-2">
                                        <span th:if="${bet.creator.username == user.username}">
                                            vs <strong th:text="${bet.acceptor.username}"></strong>
                                        </span>
                                        <span th:if="${bet.acceptor.username == user.username}">
                                            vs <strong th:text="${bet.creator.username}"></strong>
                                        </span>
                                    </p>
                                    <th:block th:if="${bet.status.name() == 'CODE_SHARED'}">
                                        <div class="game-code mb-2" th:text="${bet.gameCode}"></div>
                                        <p class="text-success small mb-2">
                                            <i class="fas fa-check-circle me-1"></i>Game code shared
                                        </p>
                                    </th:block>
                                    <th:block th:if="${bet.status.name() == 'ACCEPTED' && bet.creator.username == user.username}">
                                        <div class="alert alert-warning p-2 mb-2">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Share game code with your opponent
                                        </div>
                                    </th:block>
                                    <div class="d-flex gap-2">
                                        <th:block th:if="${bet.status.name() == 'CODE_SHARED'}">
                                            <button class="btn btn-primary btn-sm action-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#submitResultModal"
                                                    th:data-bet-id="${bet.id}">
                                                Submit Result
                                            </button>
                                        </th:block>
                                        <th:block th:if="${bet.status.name() == 'ACCEPTED' && bet.creator.username == user.username}">
                                            <button class="btn btn-warning btn-sm action-btn" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#shareCodeModal"
                                                    th:data-bet-id="${bet.id}">
                                                Share Code
                                            </button>
                                        </th:block>
                                        <form th:action="@{/bets/{id}/cancel(id=${bet.id})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm action-btn"
                                                    onclick="return confirm('Cancel this match?')">
                                                Cancel
                                            </button>
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="card bet-card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Betting History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Game</th>
                                        <th>Points</th>
                                        <th>Opponent</th>
                                        <th>Result</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="bet : ${userBets}">
                                        <td th:text="${#temporals.format(bet.createdAt, 'MMM dd, HH:mm')}"></td>
                                        <td th:text="${bet.gameType}"></td>
                                        <td th:text="'‚Ç±' + ${bet.points}"></td>
                                        <td>
                                            <span th:if="${bet.creator.username == user.username && bet.acceptor != null}" 
                                                  th:text="${bet.acceptor.username}">Opponent</span>
                                            <span th:if="${bet.acceptor != null && bet.acceptor.username == user.username}" 
                                                  th:text="${bet.creator.username}">Opponent</span>
                                            <span th:if="${bet.acceptor == null}" class="text-muted">Waiting...</span>
                                        </td>
                                        <td>
                                            <th:block th:if="${bet.status.name() == 'COMPLETED'}">
                                                <span th:if="${bet.determineWinner()?.username == user.username}" 
                                                      class="badge bg-success">Won</span>
                                                <span th:if="${bet.determineWinner()?.username != user.username && bet.determineWinner() != null}" 
                                                      class="badge bg-danger">Lost</span>
                                            </th:block>
                                            <th:block th:if="${bet.status.name() == 'CANCELLED'}">
                                                <span class="badge bg-secondary">Cancelled</span>
                                            </th:block>
                                            <th:block th:if="${bet.status.name() == 'DISPUTED'}">
                                                <span class="badge bg-warning">Disputed</span>
                                            </th:block>
                                        </td>
                                        <td>
                                            <span th:classappend="${(bet.status.name() == 'COMPLETED') ? 'badge bg-success' : (bet.status.name() == 'CANCELLED') ? 'badge bg-secondary' : (bet.status.name() == 'DISPUTED') ? 'badge bg-warning' : 'badge bg-info'}"
                                                  th:text="${bet.status.name()}">
                                            </span>
                                        </td>
                                    </tr>
                                    <tr th:if="${userBets?.empty}">
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <p>No betting history yet</p>
                                            <p class="small">Start playing to see your history here!</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Share Code Modal -->
<div class="modal fade" id="shareCodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-key me-2"></i>Share Game Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="shareCodeForm" method="post">
                <div class="modal-body">
                    <p class="text-muted">Enter the game code that both players will use:</p>
                    <input type="text" name="gameCode" class="form-control form-control-lg text-center" 
                           placeholder="Enter game code" required maxlength="20">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Share Code</button>
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </form>
        </div>
    </div>
</div>

    <!-- Submit Result Modal -->
    <div class="modal fade" id="submitResultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-flag me-2"></i>Submit Game Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="submitResultForm" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Game Result</label>
                            <select name="result" class="form-select" required>
                                <option value="WIN">I Won üèÜ</option>
                                <option value="LOSE">I Lost</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Screenshot (Required if you won)</label>
                            <input type="file" name="screenshot" class="form-control" accept="image/*">
                            <div class="form-text">Upload proof of victory. Required when claiming win.</div>
                        </div>
                        <input type="hidden" name="id" id="submitResultBetId">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Result</button>
                    </div>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </form>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-user-circle me-2"></i>Your Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="points-badge d-inline-block mb-3">
                            <i class="fas fa-coins me-1"></i>
                            <span th:text="${user?.availablePoints}">1000</span> Points
                        </div>
                        <h4 th:text="${user?.username}">Username</h4>
                        <p class="text-muted" th:text="${user?.email}">email@example.com</p>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 th:text="${user?.wins ?: '0'}">0</h5>
                            <small class="text-muted">Wins</small>
                        </div>
                        <div class="col-4">
                            <h5 th:text="${user?.losses ?: '0'}">0</h5>
                            <small class="text-muted">Losses</small>
                        </div>
                        <div class="col-4">
                            <h5 th:text="${userActiveBets?.size() ?: '0'}">0</h5>
                            <small class="text-muted">Active</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const username = /*[[${user.username}]]*/ 'user';
        /*]]>*/
    </script>

    <script>
        // Modal handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Share Code Modal - Dynamic form action
            const shareCodeModal = document.getElementById('shareCodeModal');
            if (shareCodeModal) {
                shareCodeModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const betId = button.getAttribute('data-bet-id');
                    
                    // Set the form action dynamically
                    const form = document.getElementById('shareCodeForm');
                    form.action = `/bets/${betId}/set-game-code`;
                });
            }

            // Submit Result Modal - Dynamic form action
            const submitResultModal = document.getElementById('submitResultModal');
            if (submitResultModal) {
                submitResultModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const betId = button.getAttribute('data-bet-id');
                    
                    // Set the form action dynamically
                    const form = document.getElementById('submitResultForm');
                    form.action = `/bets/${betId}/submit-result`;
                });
            }

            // Initialize WebSocket
            initializeWebSocket();
        });

        // WebSocket functionality
        let stompClient = null;

        function initializeWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('WebSocket connected');
                
                stompClient.subscribe('/topic/bet-updates', function(message) {
                    const update = JSON.parse(message.body);
                    handleBetUpdate(update);
                });
                
            }, function(error) {
                console.log('WebSocket error:', error);
            });
        }

        function handleBetUpdate(update) {
            console.log('Received bet update:', update);
            if (update.type === 'NEW_BET') {
                addLiveBet(update.bet);
            } else if (update.type === 'BET_ACCEPTED') {
                removeLiveBet(update.bet.id);
                // Use a small delay to ensure the backend has processed the update
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else if (update.type === 'CODE_SHARED') {
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else if (update.type === 'BET_COMPLETED') {
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else if (update.type === 'BET_CANCELLED') {
                removeLiveBet(update.bet.id);
            }
        }

        function addLiveBet(betData) {
            if (betData.creator.username === username) return;
            
            const container = document.getElementById('liveBetsContainer');
            const noBetsMessage = container.querySelector('.text-center');
            
            if (noBetsMessage) noBetsMessage.style.display = 'none';
            
            const betElement = document.createElement('div');
            betElement.className = 'p-3 border-bottom';
            betElement.setAttribute('data-bet-id', betData.id);
            
            const betTime = betData.createdAt ? new Date(betData.createdAt).toLocaleTimeString() : 'Just now';

            betElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">NEW</span>
                            <strong class="text-success">‚Ç±${betData.points}</strong>
                        </div>
                        <h6>${betData.title || betData.gameType + ' Challenge'}</h6>
                        <p class="mb-1 text-muted small">
                            <i class="fas fa-user me-1"></i>${betData.creator.username}
                        </p>
                        <p class="mb-0 text-muted small">
                            <i class="fas fa-clock me-1"></i>${betTime}
                        </p>
                    </div>
                    <div class="text-end">
                        <form action="/bets/${betData.id}/accept" method="post">
                            <button type="submit" class="btn btn-success btn-sm action-btn"
                                    onclick="return confirm('Accept this bet?')">
                                <i class="fas fa-check me-1"></i>Accept
                            </button>
                            <input type="hidden" name="_csrf" value="${getCsrfToken()}">
                        </form>
                    </div>
                </div>
            `;
            
            container.insertBefore(betElement, container.firstChild);
            updateLiveBetsCount();
        }

        function removeLiveBet(betId) {
            const betElement = document.querySelector(`[data-bet-id="${betId}"]`);
            if (betElement) {
                betElement.remove();
                updateLiveBetsCount();
            }
        }

        function updateLiveBetsCount() {
            const container = document.getElementById('liveBetsContainer');
            const bets = container.querySelectorAll('.border-bottom');
            const countElement = document.getElementById('liveBetsCount');
            const noBetsMessage = container.querySelector('.text-center');
            
            if (countElement) {
                countElement.textContent = `${bets.length} active bet${bets.length !== 1 ? 's' : ''}`;
            }
            
            if (noBetsMessage && bets.length === 0) {
                noBetsMessage.style.display = 'block';
            }
        }

        function getCsrfToken() {
            return document.querySelector('input[name="_csrf"]')?.value || '';
        }
    </script>
</body>
</html>