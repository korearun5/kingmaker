<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Set Game Code - Betting Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .game-code-form {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .real-time-status {
            border-left: 4px solid #28a745;
            background-color: #f8fff9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-key"></i> Set Game Code</h4>
                        <span class="badge bg-warning" id="connectionStatus">
                            <i class="fas fa-wifi"></i> Connecting...
                        </span>
                    </div>
                    <div class="card-body">
                        <!-- Flash Messages -->
                        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle"></i> 
                            <span th:text="${success}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle"></i> 
                            <span th:text="${error}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Real-time Status -->
                        <div class="real-time-status" id="realTimeStatus" style="display: none;">
                            <h6><i class="fas fa-bolt"></i> Live Updates</h6>
                            <div id="statusMessage">Waiting for connection...</div>
                        </div>

                        <!-- Match Information -->
                        <div class="alert alert-info">
                            <h5>Match Information</h5>
                            <p><strong>Game:</strong> <span th:text="${bet.gameType}">Chess</span></p>
                            <p><strong>Points:</strong> <span th:text="${bet.points}">100</span></p>
                            <p><strong>Opponent:</strong> 
                                <span th:text="${bet.matchedBet.creator.username}">OpponentUsername</span>
                            </p>
                            <p><strong>Status:</strong> 
                                <span class="badge bg-warning" th:text="${bet.status}">ACCEPTED</span>
                            </p>
                        </div>

                        <!-- Game Code Form -->
                        <div class="game-code-form">
                            <h5>Enter Your Game Code</h5>
                            <p class="mb-3">Share the game code/room ID with your opponent. They will receive it instantly!</p>
                            
                            <form id="gameCodeForm">
                                <div class="mb-3">
                                    <input type="text" class="form-control form-control-lg text-center" 
                                           id="gameCodeInput" name="gameCode" 
                                           placeholder="e.g., CHESS-123, ROOM-ABC, MATCH-001" 
                                           required maxlength="50"
                                           style="font-size: 1.2rem; font-weight: bold;">
                                    <div class="form-text text-white">
                                        This could be a chess game ID, COD match code, Valorant room code, etc.
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-light btn-lg" id="shareCodeBtn">
                                    <i class="fas fa-share"></i> Share Code Instantly
                                </button>
                            </form>

                            <!-- Success Message -->
                            <div id="successMessage" class="alert alert-success mt-3" style="display: none;">
                                <i class="fas fa-check-circle"></i> 
                                <span id="successText">Code shared successfully! Your opponent has been notified.</span>
                                <div class="mt-2">
                                    <a th:href="@{/bets/{betId}/game-code(betId=${bet.id})}" class="btn btn-success btn-sm">
                                        <i class="fas fa-arrow-right"></i> Continue to Game Code Page
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-info-circle"></i> Important:</h6>
                            <ul class="mb-0">
                                <li>Set the game code <strong>after</strong> your opponent has accepted the challenge</li>
                                <li>Both players will see this code instantly via real-time updates</li>
                                <li>Use this code to connect and play your match</li>
                                <li>After setting the code, you can proceed to submit results</li>
                            </ul>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center">
                            <a th:href="@{/dashboard}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const betId = /*[[${bet.id}]]*/ 0;
        const currentUser = /*[[${user.username}]]*/ 'user';
        /*]]>*/
    </script>

    <script>
        let stompClient = null;
        let isConnected = false;

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('✅ Connected to WebSocket for bet:', betId);
                isConnected = true;
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-wifi"></i> Live Connected';
                document.getElementById('connectionStatus').className = 'badge bg-success';
                
                // Show real-time status
                document.getElementById('realTimeStatus').style.display = 'block';
                document.getElementById('statusMessage').innerHTML = 
                    '<i class="fas fa-check text-success"></i> Real-time connection established. Your opponent will receive the code instantly.';
                
                // Join the bet room
                stompClient.send("/app/bet/" + betId + "/join", {}, 
                    JSON.stringify({'username': currentUser, 'socketId': 'web'}));
                
            }, function(error) {
                console.log('❌ WebSocket connection error');
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-wifi-slash"></i> Disconnected';
                document.getElementById('connectionStatus').className = 'badge bg-danger';
                document.getElementById('statusMessage').innerHTML = 
                    '<i class="fas fa-exclamation-triangle text-warning"></i> Real-time updates unavailable. Code will still be saved.';
                document.getElementById('realTimeStatus').style.display = 'block';
            });
        }

        function shareRoomCode() {
            const gameCodeInput = document.getElementById('gameCodeInput');
            const shareCodeBtn = document.getElementById('shareCodeBtn');
            const roomCode = gameCodeInput.value.trim();
            
            if (!roomCode) {
                alert('Please enter a game code');
                return;
            }

            // Disable button and show loading
            shareCodeBtn.disabled = true;
            shareCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sharing...';

            if (isConnected) {
                // Send via WebSocket for real-time update
                stompClient.send("/app/bet/" + betId + "/share-code", {}, 
                    JSON.stringify({'roomCode': roomCode}));
                
                // Also save via traditional form submission
                saveGameCode(roomCode);
            } else {
                // Fallback: only save via traditional method
                saveGameCode(roomCode);
            }
        }

        function saveGameCode(roomCode) {
            // Create a form and submit it to save the code
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/bets/' + betId + '/set-game-code';
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = document.querySelector('input[name="_csrf"]').value;
            
            const codeInput = document.createElement('input');
            codeInput.type = 'hidden';
            codeInput.name = 'gameCode';
            codeInput.value = roomCode;
            
            form.appendChild(csrfInput);
            form.appendChild(codeInput);
            document.body.appendChild(form);
            
            // Show success message
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('gameCodeForm').style.display = 'none';
            
            // Don't actually submit the form to avoid page reload
            // form.submit();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            // Set up event listeners
            document.getElementById('shareCodeBtn').addEventListener('click', shareRoomCode);
            
            // Allow Enter key to submit
            document.getElementById('gameCodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    shareRoomCode();
                }
            });
        });
    </script>
</body>
</html>