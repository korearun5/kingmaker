<div th:fragment="content">
    <div class="container-fluid">
        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show mt-3">
            <i class="fas fa-check-circle me-2"></i><span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-3">
            <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Create Bet Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Bet</h4>
                        <span class="badge bg-light text-dark" th:text="'Balance: ' + ${userPoints} + ' points'"></span>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/bets/create}" method="post" id="createBetForm">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="points" class="form-label">Bet Amount (Points)</label>
                                    <input type="number" class="form-control" id="points" name="points" 
                                           min="10" th:attr="max=${userPoints}" required
                                           placeholder="Enter points amount">
                                    <div class="form-text">
                                        Min: 10 points | Your available: <span th:text="${userPoints}">0</span> points
                                        <span th:if="${userPoints < 10}" class="text-danger">
                                            <i class="fas fa-exclamation-triangle ms-1"></i> You need at least 10 points
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="gameType" class="form-label">Game Type</label>
                                    <select class="form-select" id="gameType" name="gameType" required>
                                        <option value="FIFA">FIFA</option>
                                        <option value="NBA2K">NBA 2K</option>
                                        <option value="COD">Call of Duty</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="title" class="form-label">Bet Title (Optional)</label>
                                <input type="text" class="form-control" id="title" name="title"
                                       placeholder="e.g., FIFA 24 Match, NBA 2K Showdown, etc.">
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" 
                                        th:disabled="${userPoints < 10}" id="createBetBtn">
                                    <i class="fas fa-plus me-2"></i>
                                    <span th:if="${userPoints >= 10}">Create Bet Challenge</span>
                                    <span th:if="${userPoints < 10}">Insufficient Points</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Bets Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-list me-2"></i>All Bets</h4>
                        <div>
                            <span class="badge bg-light text-dark me-2" th:text="'Total: ' + (${allBets?.totalElements ?: 0})"></span>
                            <span class="badge bg-warning text-dark" th:text="'Page: ' + (${allBets?.number ?: 0} + 1) + '/' + (${allBets?.totalPages ?: 1})"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div th:if="${allBets != null and !allBets.empty}" class="row">
                            <div th:each="bet : ${allBets.content}" class="col-md-6 col-lg-4 mb-3">
                                <div th:class="'card h-100 shadow-sm ' + 
                                    (${bet.creator != null and bet.creator.username == user.username} ? 'border-primary' : 
                                    (${bet.status.name() == 'PENDING'} ? 'border-warning' : 'border-secondary'))">
                                    <div class="card-body">
                                        <!-- Bet Header -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0 text-truncate" th:text="${bet.title}">Bet Title</h6>
                                            <span class="badge" 
                                                th:classappend="${bet.status.name() == 'PENDING'} ? 'bg-warning text-dark' : 
                                                                (${bet.status.name() == 'ACCEPTED'} ? 'bg-success' : 
                                                                (${bet.status.name() == 'CODE_SHARED'} ? 'bg-info' : 'bg-secondary'))"
                                                th:text="${bet.status}">Status</span>
                                        </div>
                                        
                                        <!-- Bet Details -->
                                        <div class="mb-3">
                                            <div class="small text-muted mb-1">
                                                <i class="fas fa-coins me-1"></i>
                                                <strong>Points:</strong> <span th:text="${bet.points}">0</span>
                                            </div>
                                            <div class="small text-muted mb-1">
                                                <i class="fas fa-gamepad me-1"></i>
                                                <strong>Game:</strong> <span th:text="${bet.gameType}">FIFA</span>
                                            </div>
                                            <div class="small text-muted mb-1">
                                                <i class="fas fa-user me-1"></i>
                                                <strong>By:</strong> 
                                                <span th:if="${bet.creator != null}" 
                                                      th:class="${bet.creator.username == user.username} ? 'text-primary fw-bold' : ''"
                                                      th:text="${bet.creator.username}">User</span>
                                                <span th:if="${bet.creator == null}" class="text-danger">Unknown User</span>
                                            </div>
                                            <div class="small text-muted" th:if="${bet.acceptor != null}">
                                                <i class="fas fa-users me-1"></i>
                                                <strong>vs:</strong> 
                                                <span th:class="${bet.acceptor.username == user.username} ? 'text-success fw-bold' : ''"
                                                      th:text="${bet.acceptor.username}">Opponent</span>
                                            </div>
                                        </div>

                                        <!-- Game Code Display -->
                                        <div th:if="${bet.gameCode != null}" class="alert alert-success p-2 mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong><i class="fas fa-key me-1"></i>Game Code:</strong> 
                                                    <code class="ms-1" th:text="${bet.gameCode}"></code>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-success" 
                                                        onclick="copyToClipboard(this)" data-code="${bet.gameCode}">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="action-buttons">
                                            <!-- Accept Button (for other users when pending) -->
                                            <div th:if="${bet.status.name() == 'PENDING'}">
                                                <div th:if="${bet.creator != null and bet.creator.username != user.username}">
                                                    <form th:action="@{/bets/{id}/accept(id=${bet.id})}" method="post" class="mb-2">
                                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                        <button type="submit" class="btn btn-success btn-sm w-100" 
                                                                th:disabled="${userPoints < bet.points}"
                                                                th:attr="data-bs-toggle=${userPoints < bet.points} ? 'tooltip' : ''"
                                                                th:title="${userPoints < bet.points} ? 'You need ' + ${bet.points} + ' points to accept this bet' : ''">
                                                            <i class="fas fa-check me-1"></i>
                                                            <span th:if="${userPoints >= bet.points}">Accept Bet</span>
                                                            <span th:if="${userPoints < bet.points}">Need <span th:text="${bet.points}"></span> points</span>
                                                        </button>
                                                    </form>
                                                </div>
                                                <div th:if="${bet.creator != null and bet.creator.username == user.username}" class="text-center">
                                                    <small class="text-muted">Waiting for someone to accept your bet...</small>
                                                </div>
                                            </div>

                                            <!-- Cancel Button (for creator when pending) -->
                                            <div th:if="${bet.status.name() == 'PENDING' and bet.creator != null and bet.creator.username == user.username}">
                                                <form th:action="@{/bets/{id}/cancel(id=${bet.id})}" method="post" 
                                                      onsubmit="return confirmCancel('pending')" class="mb-2">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                    <button type="submit" class="btn btn-danger btn-sm w-100">
                                                        <i class="fas fa-times me-1"></i>Cancel Bet
                                                    </button>
                                                </form>
                                            </div>

                                            <!-- Share Code Button (for creator when accepted) -->
                                            <div th:if="${bet.status.name() == 'ACCEPTED' and bet.creator != null and bet.creator.username == user.username and bet.gameCode == null}">
                                                <form th:action="@{/bets/{id}/set-game-code(id=${bet.id})}" method="post" class="mb-2">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" name="gameCode" 
                                                               placeholder="Enter game code" required
                                                               pattern="[A-Za-z0-9]{4,10}" 
                                                               title="Game code should be 4-10 alphanumeric characters">
                                                        <button type="submit" class="btn btn-info">
                                                            <i class="fas fa-share"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text small">Enter the room/match code</div>
                                                </form>
                                            </div>

                                            <!-- Submit Result Forms (when code is shared) -->
                                            <div th:if="${bet.status.name() == 'CODE_SHARED'}">
                                                <!-- Creator Result Form -->
                                                <div th:if="${bet.creator != null and bet.creator.username == user.username and bet.creatorResult == null}" class="mb-2">
                                                    <form th:action="@{/bets/{id}/submit-result(id=${bet.id})}" method="post">
                                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                        <input type="hidden" name="isCreator" value="true" />
                                                        <div class="input-group input-group-sm">
                                                            <select class="form-select" name="result" required>
                                                                <option value="">Select Result</option>
                                                                <option value="WIN">Win</option>
                                                                <option value="LOSS">Loss</option>
                                                                <option value="DRAW">Draw</option>
                                                            </select>
                                                            <button type="submit" class="btn btn-warning">
                                                                <i class="fas fa-flag me-1"></i>Submit Result
                                                            </button>
                                                        </div>
                                                        <div class="form-text small">Submit your game result</div>
                                                    </form>
                                                </div>
                                                
                                                <!-- Acceptor Result Form -->
                                                <div th:if="${bet.acceptor != null and bet.acceptor.username == user.username and bet.acceptorResult == null}" class="mb-2">
                                                    <form th:action="@{/bets/{id}/submit-result(id=${bet.id})}" method="post">
                                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                        <input type="hidden" name="isCreator" value="false" />
                                                        <div class="input-group input-group-sm">
                                                            <select class="form-select" name="result" required>
                                                                <option value="">Select Result</option>
                                                                <option value="WIN">Win</option>
                                                                <option value="LOSS">Loss</option>
                                                                <option value="DRAW">Draw</option>
                                                            </select>
                                                            <button type="submit" class="btn btn-warning">
                                                                <i class="fas fa-flag me-1"></i>Submit Result
                                                            </button>
                                                        </div>
                                                        <div class="form-text small">Submit your game result</div>
                                                    </form>
                                                </div>
                                                
                                                <!-- Show submitted results -->
                                                <div th:if="${bet.creatorResult != null or bet.acceptorResult != null}" class="mb-2">
                                                    <div class="small text-muted">
                                                        <strong>Results Submitted:</strong>
                                                        <div th:if="${bet.creatorResult != null}">
                                                            Creator: <span th:text="${bet.creatorResult}"></span>
                                                        </div>
                                                        <div th:if="${bet.acceptorResult != null}">
                                                            Acceptor: <span th:text="${bet.acceptorResult}"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Cancel Button (for both users when accepted/code shared) -->
                                            <div th:if="${(bet.status.name() == 'ACCEPTED' or bet.status.name() == 'CODE_SHARED') and 
                                                         ((bet.creator != null and bet.creator.username == user.username) or 
                                                          (bet.acceptor != null and bet.acceptor.username == user.username))}">
                                                <form th:action="@{/bets/{id}/cancel(id=${bet.id})}" method="post" 
                                                      onsubmit="return confirmCancel('active')">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                                        <i class="fas fa-times me-1"></i>Cancel Bet
                                                    </button>
                                                </form>
                                            </div>

                                            <!-- My Bet Indicator -->
                                            <div th:if="${bet.creator != null and bet.creator.username == user.username}" class="text-center mt-2">
                                                <small class="text-primary">
                                                    <i class="fas fa-star me-1"></i>Your Bet
                                                </small>
                                            </div>
                                            <div th:if="${bet.acceptor != null and bet.acceptor.username == user.username}" class="text-center mt-2">
                                                <small class="text-success">
                                                    <i class="fas fa-user-check me-1"></i>You Accepted
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Card Footer with Timestamp -->
                                    <div class="card-footer bg-transparent border-top-0 pt-0">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            <span th:text="${#temporals.format(bet.createdAt, 'MMM dd, HH:mm')}"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${allBets == null or allBets.empty}" class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No bets available</h5>
                            <p class="text-muted">Create your first bet challenge to get started!</p>
                        </div>

                        <!-- Pagination -->
                        <div th:if="${allBets != null and allBets.totalPages > 1}" class="mt-4">
                            <nav aria-label="Bets pagination">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${allBets.first} ? 'disabled' : ''">
                                        <a class="page-link" th:href="@{/user/play(page=0)}">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item" th:classappend="${allBets.hasPrevious()} ? '' : 'disabled'">
                                        <a class="page-link" th:href="@{/user/play(page=${allBets.number-1})}">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                    
                                    <!-- Page numbers -->
                                    <li th:each="i : ${#numbers.sequence(0, allBets.totalPages-1)}" 
                                        class="page-item" th:classappend="${i == allBets.number} ? 'active' : ''">
                                        <a class="page-link" th:href="@{/user/play(page=${i})}" th:text="${i+1}">1</a>
                                    </li>
                                    
                                    <li class="page-item" th:classappend="${allBets.hasNext()} ? '' : 'disabled'">
                                        <a class="page-link" th:href="@{/user/play(page=${allBets.number+1})}">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item" th:classappend="${allBets.last} ? 'disabled' : ''">
                                        <a class="page-link" th:href="@{/user/play(page=${allBets.totalPages-1})}">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Replace the entire polling script in play-content.html with this: -->

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    class DebugWebSocketManager {
        constructor() {
            this.stompClient = null;
            this.connected = false;
            this.username = '[[${user?.username}]]';
            this.debugEnabled = true;
            this.reconnectAttempts = 0;
            this.maxReconnectAttempts = 5;
        }

        log(message, data = null) {
            if (this.debugEnabled) {
                const timestamp = new Date().toISOString();
                console.log(`[WebSocket ${timestamp}] ${message}`, data || '');
                
                // Also show in UI for debugging
                this.showDebugMessage(`[${timestamp}] ${message}`);
            }
        }

        showDebugMessage(message) {
            // Create debug panel if it doesn't exist
            let debugPanel = document.getElementById('websocket-debug-panel');
            if (!debugPanel) {
                debugPanel = document.createElement('div');
                debugPanel.id = 'websocket-debug-panel';
                debugPanel.style.cssText = `
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    width: 400px;
                    height: 300px;
                    background: #f8f9fa;
                    border: 1px solid #ccc;
                    padding: 10px;
                    overflow-y: auto;
                    font-size: 12px;
                    z-index: 10000;
                    display: none;
                `;
                document.body.appendChild(debugPanel);
            }
            
            const messageElement = document.createElement('div');
            messageElement.style.cssText = 'margin-bottom: 5px; padding: 2px; border-bottom: 1px solid #eee;';
            messageElement.textContent = message;
            debugPanel.appendChild(messageElement);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        connect() {
            this.log('Attempting WebSocket connection...');
            
            try {
                const socket = new SockJS('/ws');
                this.stompClient = Stomp.over(socket);
                
                // Enable STOMP debugging
                this.stompClient.debug = (str) => {
                    this.log('STOMP Debug:', str);
                };
                
                this.log('SockJS created, attempting STOMP connection...');
                
                const headers = {};
                
                this.stompClient.connect(headers, 
                    // Success callback
                    (frame) => {
                        this.log('WebSocket connected successfully!', frame);
                        this.connected = true;
                        this.reconnectAttempts = 0;
                        
                        this.subscribeToChannels();
                        this.notifyServer();
                        
                        this.showNotification('WebSocket connected!', 'success');
                    }, 
                    // Error callback
                    (error) => {
                        this.log('WebSocket connection failed:', error);
                        this.connected = false;
                        this.handleReconnection();
                    }
                );
                
            } catch (error) {
                this.log('Error creating WebSocket connection:', error);
                this.handleReconnection();
            }
        }

        subscribeToChannels() {
            this.log('Subscribing to WebSocket channels...');
            
            try {
                // Global bet updates
                const betsSubscription = this.stompClient.subscribe('/topic/bets/all', (message) => {
                    this.log('Received message on /topic/bets/all:', message.body);
                    this.handleBetMessage(JSON.parse(message.body));
                });
                this.log('Subscribed to /topic/bets/all');

                // User-specific updates
                const userSubscription = this.stompClient.subscribe('/user/queue/bet-updates', (message) => {
                    this.log('Received message on /user/queue/bet-updates:', message.body);
                    this.handleBetMessage(JSON.parse(message.body));
                });
                this.log('Subscribed to /user/queue/bet-updates');

                // Notifications
                const notificationsSubscription = this.stompClient.subscribe('/user/queue/notifications', (message) => {
                    this.log('Received message on /user/queue/notifications:', message.body);
                    this.handleNotification(JSON.parse(message.body));
                });
                this.log('Subscribed to /user/queue/notifications');

                // Test subscription
                const testSubscription = this.stompClient.subscribe('/topic/test', (message) => {
                    this.log('Test message received:', message.body);
                });
                this.log('Subscribed to /topic/test');

            } catch (error) {
                this.log('Error subscribing to channels:', error);
            }
        }

        handleBetMessage(message) {
            this.log('Processing bet message:', message);
            
            switch (message.type) {
                case 'NEW_BET':
                    this.log('NEW_BET received', message.bet);
                    this.addNewBet(message.bet);
                    break;
                case 'BET_ACCEPTED':
                    this.log('BET_ACCEPTED received', message.payload);
                    this.updateBet(message.payload);
                    this.showNotification('Your bet has been accepted!', 'success');
                    break;
                case 'CODE_SHARED':
                    this.log('CODE_SHARED received', message.payload);
                    this.updateBet(message.payload);
                    this.showNotification('Game code has been shared!', 'info');
                    break;
                case 'RESULT_SUBMITTED':
                    this.log('RESULT_SUBMITTED received', message.payload);
                    this.handleResultSubmitted(message.payload);
                    break;
                case 'BET_CANCELLED':
                    this.log('BET_CANCELLED received', message.payload);
                    this.removeBet(message.payload);
                    this.showNotification('Bet has been cancelled', 'warning');
                    break;
                case 'BET_COMPLETED':
                    this.log('BET_COMPLETED received', message.payload);
                    this.updateBet(message.payload);
                    this.showNotification('Bet completed!', 'success');
                    break;
                case 'POINTS_UPDATED':
                    this.log('POINTS_UPDATED received', message.payload);
                    this.updateUserPoints(message.payload);
                    break;
                default:
                    this.log('Unknown message type:', message.type);
            }
        }

        handleNotification(message) {
            this.log('Processing notification:', message);
            if (message.type === 'BET_ACCEPTED') {
                this.showNotification('Your bet has been accepted!', 'success');
            } else if (message.type === 'CODE_SHARED') {
                this.showNotification('Game code has been shared for your bet!', 'info');
            }
        }

        notifyServer() {
            if (this.stompClient && this.connected) {
                this.log('Notifying server of connection...');
                this.stompClient.send("/app/bets/subscribe", {}, JSON.stringify({
                    username: this.username,
                    timestamp: new Date().toISOString()
                }));
            }
        }

        sendTestMessage() {
            if (this.stompClient && this.connected) {
                this.log('Sending test message...');
                this.stompClient.send("/app/test", {}, JSON.stringify({
                    message: 'Test from client',
                    username: this.username,
                    timestamp: new Date().toISOString()
                }));
            } else {
                this.log('Cannot send test message - not connected');
            }
        }

        handleReconnection() {
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                this.reconnectAttempts++;
                const delay = 3000 * this.reconnectAttempts;
                this.log(`Reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${delay}ms`);
                
                setTimeout(() => {
                    this.log('Attempting reconnection...');
                    this.connect();
                }, delay);
            } else {
                this.log('Max reconnection attempts reached');
                this.showNotification('Real-time updates unavailable. Please refresh page.', 'error');
            }
        }

        disconnect() {
            this.log('Disconnecting WebSocket...');
            if (this.stompClient) {
                this.stompClient.disconnect();
            }
            this.connected = false;
        }

        getStatus() {
            return {
                connected: this.connected,
                reconnectAttempts: this.reconnectAttempts,
                username: this.username
            };
        }

        // UI update methods (simplified versions)
        addNewBet(betData) {
            this.log('Adding new bet:', betData);
            // Force page refresh for now until we implement dynamic updates
            window.location.reload();
        }

        updateBet(betData) {
            this.log('Updating bet:', betData);
            window.location.reload();
        }

        removeBet(betData) {
            this.log('Removing bet:', betData);
            window.location.reload();
        }

        updateUserPoints(pointsData) {
            this.log('Updating points:', pointsData);
            // Update points display
            const pointsElement = document.querySelector('.user-points span:last-child');
            if (pointsElement) {
                pointsElement.textContent = pointsData.availablePoints + ' Points';
            }
        }

        showNotification(message, type = 'info') {
            this.log('Showing notification:', { message, type });
            
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
    }

    // Initialize and expose for debugging
    document.addEventListener('DOMContentLoaded', function() {
        window.wsManager = new DebugWebSocketManager();
        window.wsManager.connect();

        // Add debug controls to page
        addDebugControls();
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (window.wsManager) {
                window.wsManager.disconnect();
            }
        });

        // Test WebSocket every 10 seconds
        setInterval(() => {
            if (window.wsManager && window.wsManager.connected) {
                window.wsManager.sendTestMessage();
            }
        }, 10000);
    });

    function addDebugControls() {
        const debugControls = document.createElement('div');
        debugControls.style.cssText = 'position: fixed; bottom: 10px; left: 10px; z-index: 10000;';
        debugControls.innerHTML = `
            <div class="btn-group-vertical">
                <button class="btn btn-sm btn-info" onclick="window.wsManager.connect()">Connect WS</button>
                <button class="btn btn-sm btn-warning" onclick="window.wsManager.disconnect()">Disconnect WS</button>
                <button class="btn btn-sm btn-success" onclick="window.wsManager.sendTestMessage()">Test WS</button>
                <button class="btn btn-sm btn-secondary" onclick="toggleDebugPanel()">Toggle Debug</button>
                <button class="btn btn-sm btn-primary" onclick="checkWSStatus()">Status</button>
            </div>
        `;
        document.body.appendChild(debugControls);
    }

    function toggleDebugPanel() {
        const panel = document.getElementById('websocket-debug-panel');
        if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
    }

    function checkWSStatus() {
        if (window.wsManager) {
            const status = window.wsManager.getStatus();
            alert(`WebSocket Status:\nConnected: ${status.connected}\nUsername: ${status.username}\nReconnect Attempts: ${status.reconnectAttempts}`);
        } else {
            alert('WebSocket manager not initialized');
        }
    }
</script>
<!-- Add this to your play-content.html -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
// Simple WebSocket connection test
console.log('üß™ Starting WebSocket connection test...');

const socket = new SockJS('/ws');
const stompClient = Stomp.over(socket);

// Disable STOMP debugging (it's too verbose)
stompClient.debug = null;

stompClient.connect({}, function(frame) {
    console.log('‚úÖ WebSocket Connected! User: [[${user?.username}]]');
    
    // Subscribe to test channel
    stompClient.subscribe('/topic/test', function(message) {
        const data = JSON.parse(message.body);
        console.log('üì® Received test message:', data);
        showNotification('WebSocket: ' + data.message, 'success');
    });
    
    // Subscribe to bet updates
    stompClient.subscribe('/topic/bets/all', function(message) {
        const data = JSON.parse(message.body);
        console.log('üé≤ New bet update:', data);
        if (data.type === 'NEW_BET') {
            showNotification('New bet created: ' + data.bet.title, 'info');
            // Force refresh for now
            setTimeout(() => window.location.reload(), 1000);
        }
    });
    
    // Notify server we're connected
    stompClient.send("/app/bets/subscribe", {}, JSON.stringify({
        username: '[[${user?.username}]]',
        action: 'connected'
    }));
    
}, function(error) {
    console.error('‚ùå WebSocket connection failed:', error);
});

function showNotification(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.main-content').prepend(alert);
    
    setTimeout(() => {
        if (alert.parentNode) alert.remove();
    }, 5000);
}

// Make it globally available for testing
window.wsClient = stompClient;
</script>
</div>